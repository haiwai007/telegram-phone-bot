name: ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®åº“

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'ç¡®è®¤æ¸…ç©ºæ•°æ®åº“ (è¾“å…¥ "CONFIRM" ç¡®è®¤)'
        required: true
        default: ''

jobs:
  clear-database:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "requirements.txt" ]; then
          echo "âœ… æ‰¾åˆ° requirements.txt"
          pip install -r requirements.txt
        else
          echo "âŒ æœªæ‰¾åˆ° requirements.txtï¼Œä½¿ç”¨æ‰‹åŠ¨å®‰è£…"
          pip install python-telegram-bot==20.8 python-dotenv==1.0.1 requests==2.31.0 pytz==2023.3
        fi
        
    - name: ğŸ”§ é…ç½®ç¯å¢ƒ
      run: |
        mkdir -p é…ç½®æ–‡ä»¶
        echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "LOG_LEVEL=INFO" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "TIMEZONE=Asia/Shanghai" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "DATABASE_PATH=phone_records.db" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        
    - name: âœ‹ éªŒè¯ç¡®è®¤è¾“å…¥
      run: |
        if [ "${{ github.event.inputs.confirm }}" != "CONFIRM" ]; then
          echo "âŒ æœªæ­£ç¡®ç¡®è®¤æ¸…ç©ºæ“ä½œ"
          echo "ğŸ’¡ è¯·åœ¨å·¥ä½œæµè¾“å…¥ä¸­è¾“å…¥ 'CONFIRM' æ¥ç¡®è®¤æ¸…ç©ºæ•°æ®åº“"
          exit 1
        fi
        echo "âœ… ç¡®è®¤è¾“å…¥éªŒè¯é€šè¿‡"
        
    - name: ğŸ“Š æ£€æŸ¥å½“å‰æ•°æ®åº“çŠ¶æ€
      run: |
        echo "ğŸ“Š æ£€æŸ¥æ•°æ®åº“çŠ¶æ€..."
        python -c "
        import os
        import sqlite3
        from pathlib import Path
        
        db_path = 'phone_records.db'
        
        if not os.path.exists(db_path):
            print('ğŸ“ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨')
            exit(0)
        
        try:
            conn = sqlite3.connect(db_path)
            cursor = conn.cursor()
            
            # è·å–æ‰€æœ‰è¡¨
            cursor.execute('SELECT name FROM sqlite_master WHERE type=\"table\";')
            tables = cursor.fetchall()
            
            if not tables:
                print('ğŸ“ æ•°æ®åº“ä¸­æ²¡æœ‰è¡¨')
                conn.close()
                exit(0)
            
            total_records = 0
            for table in tables:
                table_name = table[0]
                cursor.execute(f'SELECT COUNT(*) FROM {table_name}')
                count = cursor.fetchone()[0]
                print(f'ğŸ“‹ è¡¨ {table_name}: {count} æ¡è®°å½•')
                total_records += count
            
            print(f'ğŸ“Š æ€»è®°å½•æ•°: {total_records}')
            conn.close()
            
            if total_records == 0:
                print('ğŸ“ æ•°æ®åº“å·²ç»æ˜¯ç©ºçš„')
                exit(0)
                
        except Exception as e:
            print(f'âŒ æ£€æŸ¥æ•°æ®åº“å¤±è´¥: {e}')
            exit(1)
        "
        
    - name: ğŸ—‘ï¸ æ‰§è¡Œæ•°æ®åº“æ¸…ç©º
      run: |
        echo "ğŸ—‘ï¸ å¼€å§‹æ¸…ç©ºæ•°æ®åº“..."
        echo "â° å¼€å§‹æ—¶é—´: $(date)"
        
        python æ¸…ç©ºæ•°æ®åº“.py
        
        echo "â° å®Œæˆæ—¶é—´: $(date)"
        
    - name: ğŸ“Š éªŒè¯æ¸…ç©ºç»“æœ
      run: |
        echo "ğŸ“Š éªŒè¯æ¸…ç©ºç»“æœ..."
        python -c "
        import os
        import sqlite3
        
        db_path = 'phone_records.db'
        
        if not os.path.exists(db_path):
            print('âœ… æ•°æ®åº“æ–‡ä»¶å·²åˆ é™¤')
            exit(0)
        
        try:
            conn = sqlite3.connect(db_path)
            cursor = conn.cursor()
            
            # è·å–æ‰€æœ‰è¡¨
            cursor.execute('SELECT name FROM sqlite_master WHERE type=\"table\";')
            tables = cursor.fetchall()
            
            if not tables:
                print('âœ… æ•°æ®åº“ä¸­æ²¡æœ‰è¡¨')
                conn.close()
                exit(0)
            
            total_records = 0
            for table in tables:
                table_name = table[0]
                cursor.execute(f'SELECT COUNT(*) FROM {table_name}')
                count = cursor.fetchone()[0]
                total_records += count
            
            conn.close()
            
            if total_records == 0:
                print('âœ… æ•°æ®åº“æ¸…ç©ºæˆåŠŸï¼Œæ‰€æœ‰è¡¨éƒ½æ˜¯ç©ºçš„')
            else:
                print(f'âš ï¸ æ•°æ®åº“æ¸…ç©ºä¸å®Œæ•´ï¼Œä»æœ‰ {total_records} æ¡è®°å½•')
                exit(1)
                
        except Exception as e:
            print(f'âŒ éªŒè¯å¤±è´¥: {e}')
            exit(1)
        "
        
    - name: ğŸ“¤ ä¸Šä¼ å¤‡ä»½æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: database-backup-${{ github.run_number }}
        path: |
          *.backup_*
          *.db
        retention-days: 30
        
    - name: âœ… æ¸…ç©ºå®Œæˆ
      run: |
        echo "ğŸ‰ æ•°æ®åº“æ¸…ç©ºæ“ä½œå®Œæˆï¼"
        echo "ğŸ“… æ¸…ç©ºæ—¥æœŸ: $(date +%Y-%m-%d)"
        echo "â° æ¸…ç©ºæ—¶é—´: $(date)"
        echo "ğŸ’¾ å¤‡ä»½æ–‡ä»¶å·²ä¸Šä¼ åˆ° GitHub Artifacts"
        echo "ğŸ—‚ï¸ å¤‡ä»½ä¿ç•™æœŸé™: 30å¤©"
        echo ""
        echo "âš ï¸ æ³¨æ„: æ­¤æ“ä½œä¸å¯é€†ï¼Œè¯·ç¡®ä¿æ‚¨çœŸçš„éœ€è¦æ¸…ç©ºæ•°æ®åº“"
