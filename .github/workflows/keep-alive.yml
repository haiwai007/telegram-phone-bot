name: ğŸ”„ ä¿æŒæœºå™¨äººè¿è¡Œ

on:
  schedule:
    # æ¯5å°æ—¶50åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ï¼Œç¡®ä¿è¿ç»­è¿è¡Œ
    - cron: '50 */5 * * *'
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    
    strategy:
      matrix:
        instance: [1, 2, 3]  # åˆ›å»º3ä¸ªå®ä¾‹ï¼Œç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªåœ¨è¿è¡Œ
      fail-fast: false
      
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r é…ç½®æ–‡ä»¶/ä¾èµ–åŒ…åˆ—è¡¨.txt
        
    - name: ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡
      run: |
        echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "DATABASE_PATH=phone_records_${{ matrix.instance }}.db" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "LOG_LEVEL=INFO" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "LOG_FILE=bot_${{ matrix.instance }}.log" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "TIMEZONE=Asia/Shanghai" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "MAX_PHONE_LENGTH=15" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "MIN_PHONE_LENGTH=8" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "RATE_LIMIT_MESSAGES=10" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "RATE_LIMIT_WINDOW=60" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "AUTHORIZED_GROUPS=${{ secrets.AUTHORIZED_GROUPS }}" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        
    - name: â° ç­‰å¾…å¯åŠ¨æ—¶é—´å·®
      run: |
        # ä¸ºä¸åŒå®ä¾‹è®¾ç½®å¯åŠ¨å»¶è¿Ÿï¼Œé¿å…å†²çª
        delay=$(((${{ matrix.instance }} - 1) * 30))
        echo "å®ä¾‹ ${{ matrix.instance }} ç­‰å¾… ${delay} ç§’åå¯åŠ¨..."
        sleep $delay
        
    - name: ğŸš€ å¯åŠ¨æœºå™¨äººå®ä¾‹ ${{ matrix.instance }}
      run: |
        echo "ğŸ¤– å¯åŠ¨æœºå™¨äººå®ä¾‹ ${{ matrix.instance }}..."
        echo "â° å¼€å§‹æ—¶é—´: $(date)"
        
        # ä½¿ç”¨è¶…æ—¶æ§åˆ¶ï¼Œç¡®ä¿åœ¨GitHub Actionsé™åˆ¶å‰ç»“æŸ
        timeout 20700 python å¯åŠ¨æœºå™¨äºº.py || {
          echo "âš ï¸ å®ä¾‹ ${{ matrix.instance }} è¿è¡Œå®Œæˆ"
          echo "â° ç»“æŸæ—¶é—´: $(date)"
          exit 0
        }
        
    - name: ğŸ“Š ä¸Šä¼ å®ä¾‹æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bot-logs-instance-${{ matrix.instance }}-${{ github.run_number }}
        path: |
          æ—¥å¿—æ•°æ®/*.log
          æ—¥å¿—æ•°æ®/*.db
        retention-days: 3
