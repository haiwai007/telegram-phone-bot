name: ğŸ”„ ä¿æŒæœºå™¨äººè¿è¡Œ

on:
  schedule:
    # æ¯6å°æ—¶10åˆ†é’Ÿå¯åŠ¨ä¸€æ¬¡ï¼Œä½œä¸ºå¤‡ç”¨å®ä¾‹
    - cron: '10 */6 * * *'
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6å°æ—¶è¶…æ—¶
    # ç§»é™¤å¹¶è¡Œå®ä¾‹ï¼Œé¿å…å†²çª
    # strategy:
    #   matrix:
    #     instance: [1, 2, 3]  # 3ä¸ªå¹¶è¡Œå®ä¾‹
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "requirements.txt" ]; then
          echo "âœ… æ‰¾åˆ° requirements.txt"
          pip install -r requirements.txt
        else
          echo "âŒ æœªæ‰¾åˆ° requirements.txtï¼Œä½¿ç”¨æ‰‹åŠ¨å®‰è£…"
          pip install python-telegram-bot==20.8 python-dotenv==1.0.1 requests==2.31.0 pytz==2023.3
        fi
        
    - name: ğŸ”§ é…ç½®ç¯å¢ƒ
      run: |
        mkdir -p é…ç½®æ–‡ä»¶
        echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "LOG_LEVEL=INFO" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "TIMEZONE=Asia/Shanghai" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "DATABASE_PATH=phone_records.db" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        
    - name: ğŸš€ å¯åŠ¨æœºå™¨äººå¤‡ç”¨å®ä¾‹
      run: |
        echo "ğŸ¤– å¯åŠ¨æœºå™¨äººå¤‡ç”¨å®ä¾‹..."
        echo "â° å¼€å§‹æ—¶é—´: $(date)"
        echo "ğŸ”„ å°†è¿è¡Œçº¦6å°æ—¶"

        # è®¾ç½®å¤‡ç”¨å®ä¾‹ç¯å¢ƒå˜é‡
        export GITHUB_WORKFLOW="keep-alive"

        # å¯åŠ¨æœºå™¨äººï¼Œè®¾ç½®è¶…æ—¶
        timeout 21000 python å¯åŠ¨æœºå™¨äºº.py || {
          echo "âš ï¸ å¤‡ç”¨å®ä¾‹è¿è¡Œè¶…æ—¶ï¼Œæ­£å¸¸ç»“æŸ"
          echo "â° ç»“æŸæ—¶é—´: $(date)"
          exit 0
        }
        
    - name: ğŸ“Š ä¸Šä¼ å¤‡ç”¨å®ä¾‹æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backup-instance-logs-${{ github.run_number }}
        path: |
          *.log
          *.db
        retention-days: 3
