name: ğŸ’¾ æ•°æ®å¤‡ä»½

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½æ•°æ®
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r é…ç½®æ–‡ä»¶/ä¾èµ–åŒ…åˆ—è¡¨.txt
        
    - name: ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡
      run: |
        echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "DATABASE_PATH=phone_records.db" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "LOG_LEVEL=INFO" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "TIMEZONE=Asia/Shanghai" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "MAX_PHONE_LENGTH=15" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "MIN_PHONE_LENGTH=8" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        
    - name: ğŸ“Š åˆ›å»ºæ•°æ®å¤‡ä»½
      run: |
        echo "ğŸ’¾ å¼€å§‹æ•°æ®å¤‡ä»½..."
        mkdir -p å¤‡ä»½æ•°æ®
        
        # åˆ›å»ºå¤‡ä»½è„šæœ¬
        cat > å¤‡ä»½æ•°æ®/backup_script.py << 'EOF'
        import sys
        import os
        import json
        import sqlite3
        from datetime import datetime
        
        # æ·»åŠ æ ¸å¿ƒæ¨¡å—è·¯å¾„
        sys.path.insert(0, 'æ ¸å¿ƒæ¨¡å—')
        
        try:
            from æ•°æ®åº“ç®¡ç† import DatabaseManager
            
            # åˆå§‹åŒ–æ•°æ®åº“ç®¡ç†å™¨
            db = DatabaseManager()
            
            # è·å–æ‰€æœ‰è®°å½•
            records = db.get_all_records()
            stats = db.get_statistics()
            
            # åˆ›å»ºå¤‡ä»½æ•°æ®
            backup_data = {
                'backup_time': datetime.now().isoformat(),
                'statistics': stats,
                'total_records': len(records),
                'records': records
            }
            
            # ä¿å­˜ä¸ºJSONæ ¼å¼
            backup_file = f"å¤‡ä»½æ•°æ®/backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
            with open(backup_file, 'w', encoding='utf-8') as f:
                json.dump(backup_data, f, ensure_ascii=False, indent=2)
            
            print(f"âœ… å¤‡ä»½å®Œæˆ: {backup_file}")
            print(f"ğŸ“Š å¤‡ä»½ç»Ÿè®¡:")
            print(f"  - æ€»è®°å½•æ•°: {len(records)}")
            print(f"  - å”¯ä¸€å·ç : {stats.get('unique_phones', 0)}")
            print(f"  - é‡å¤è®°å½•: {stats.get('duplicate_count', 0)}")
            
        except Exception as e:
            print(f"âŒ å¤‡ä»½å¤±è´¥: {e}")
            exit(1)
        EOF
        
        python å¤‡ä»½æ•°æ®/backup_script.py
        
    - name: ğŸ“¤ ä¸Šä¼ å¤‡ä»½æ–‡ä»¶
      uses: actions/upload-artifact@v3
      with:
        name: data-backup-${{ github.run_number }}
        path: å¤‡ä»½æ•°æ®/*.json
        retention-days: 30
        
    - name: ğŸ“‹ å¤‡ä»½æŠ¥å‘Š
      run: |
        echo "ğŸ“Š å¤‡ä»½å®ŒæˆæŠ¥å‘Š"
        echo "=================="
        echo "ğŸ“… å¤‡ä»½æ—¶é—´: $(date)"
        echo "ğŸ“ å¤‡ä»½æ–‡ä»¶:"
        ls -la å¤‡ä»½æ•°æ®/
        echo "âœ… å¤‡ä»½å·²ä¸Šä¼ åˆ° GitHub Artifacts"
        echo "ğŸ”„ ä¿ç•™æœŸé™: 30å¤©"
