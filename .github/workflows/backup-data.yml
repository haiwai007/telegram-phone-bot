name: ðŸ’¾ æ•°æ®å¤‡ä»½

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ”§ é…ç½®çŽ¯å¢ƒ
      run: |
        mkdir -p é…ç½®æ–‡ä»¶
        echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > é…ç½®æ–‡ä»¶/çŽ¯å¢ƒé…ç½®.env
        echo "LOG_LEVEL=INFO" >> é…ç½®æ–‡ä»¶/çŽ¯å¢ƒé…ç½®.env
        echo "TIMEZONE=Asia/Shanghai" >> é…ç½®æ–‡ä»¶/çŽ¯å¢ƒé…ç½®.env
        echo "DATABASE_PATH=phone_records.db" >> é…ç½®æ–‡ä»¶/çŽ¯å¢ƒé…ç½®.env
        
    - name: ðŸ’¾ åˆ›å»ºæ•°æ®å¤‡ä»½
      run: |
        echo "ðŸ’¾ å¼€å§‹æ•°æ®å¤‡ä»½..."
        echo "â° å¤‡ä»½æ—¶é—´: $(date)"
        
        # åˆ›å»ºå¤‡ä»½ç›®å½•
        mkdir -p backup
        
        # å¦‚æžœæ•°æ®åº“æ–‡ä»¶å­˜åœ¨ï¼Œåˆ›å»ºå¤‡ä»½
        if [ -f "phone_records.db" ]; then
            cp phone_records.db backup/phone_records_$(date +%Y%m%d_%H%M%S).db
            echo "âœ… æ•°æ®åº“å¤‡ä»½å®Œæˆ"
        else
            echo "âš ï¸ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºå¤‡ä»½"
            touch backup/no_database_$(date +%Y%m%d_%H%M%S).txt
        fi
        
        # å¤‡ä»½æ—¥å¿—æ–‡ä»¶
        if [ -f "bot.log" ]; then
            cp bot.log backup/bot_$(date +%Y%m%d_%H%M%S).log
            echo "âœ… æ—¥å¿—å¤‡ä»½å®Œæˆ"
        fi
        
        # åˆ›å»ºå¤‡ä»½ä¿¡æ¯æ–‡ä»¶
        cat > backup/backup_info.json << EOF
        {
            "backup_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "backup_date": "$(date +%Y-%m-%d)",
            "github_run_number": "${{ github.run_number }}",
            "github_sha": "${{ github.sha }}",
            "files_backed_up": [
                $(ls backup/ | grep -v backup_info.json | sed 's/.*/"&"/' | paste -sd,)
            ]
        }
        EOF
        
        echo "ðŸ“‹ å¤‡ä»½æ–‡ä»¶åˆ—è¡¨:"
        ls -la backup/
        
    - name: ðŸ“Š ç”Ÿæˆå¤‡ä»½æŠ¥å‘Š
      run: |
        python -c "
        import json
        import sqlite3
        import os
        from datetime import datetime
        
        # ç”Ÿæˆå¤‡ä»½ç»Ÿè®¡æŠ¥å‘Š
        report = {
            'backup_time': datetime.now().isoformat(),
            'total_files': 0,
            'database_records': 0,
            'log_size': 0
        }
        
        # ç»Ÿè®¡å¤‡ä»½æ–‡ä»¶
        if os.path.exists('backup'):
            backup_files = os.listdir('backup')
            report['total_files'] = len(backup_files)
            print(f'ðŸ“ å¤‡ä»½æ–‡ä»¶æ•°é‡: {len(backup_files)}')
        
        # å¦‚æžœæ•°æ®åº“å­˜åœ¨ï¼Œç»Ÿè®¡è®°å½•æ•°
        if os.path.exists('phone_records.db'):
            try:
                conn = sqlite3.connect('phone_records.db')
                cursor = conn.cursor()
                cursor.execute('SELECT COUNT(*) FROM phone_records')
                count = cursor.fetchone()[0]
                report['database_records'] = count
                conn.close()
                print(f'ðŸ“Š æ•°æ®åº“è®°å½•æ•°: {count}')
            except Exception as e:
                print(f'âš ï¸ è¯»å–æ•°æ®åº“å¤±è´¥: {e}')
        
        # ç»Ÿè®¡æ—¥å¿—å¤§å°
        if os.path.exists('bot.log'):
            log_size = os.path.getsize('bot.log')
            report['log_size'] = log_size
            print(f'ðŸ“ æ—¥å¿—æ–‡ä»¶å¤§å°: {log_size} bytes')
        
        # ä¿å­˜æŠ¥å‘Š
        with open('backup/backup_report.json', 'w') as f:
            json.dump(report, f, indent=2)
        
        print('âœ… å¤‡ä»½æŠ¥å‘Šç”Ÿæˆå®Œæˆ')
        "
        
    - name: ðŸ“¤ ä¸Šä¼ å¤‡ä»½æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: daily-backup-${{ github.run_number }}
        path: backup/
        retention-days: 30
        
    - name: âœ… å¤‡ä»½å®Œæˆ
      run: |
        echo "ðŸŽ‰ æ•°æ®å¤‡ä»½å®Œæˆï¼"
        echo "ðŸ“… å¤‡ä»½æ—¥æœŸ: $(date +%Y-%m-%d)"
        echo "â° å¤‡ä»½æ—¶é—´: $(date)"
        echo "ðŸ“¦ å¤‡ä»½å·²ä¸Šä¼ åˆ° GitHub Artifacts"
        echo "ðŸ—‚ï¸ ä¿ç•™æœŸé™: 30å¤©"
