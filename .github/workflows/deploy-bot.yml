name: ğŸ¤– Telegramæœºå™¨äºº24å°æ—¶è¿è¡Œ

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # æ¯å¤©é‡å¯ä¸€æ¬¡ (UTC 00:00, åŒ—äº¬æ—¶é—´ 08:00)
    - cron: '0 0 * * *'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 1440  # 24å°æ—¶è¶…æ—¶ (1440åˆ†é’Ÿ)
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        ls -la
        if [ -f "requirements.txt" ]; then
          echo "âœ… æ‰¾åˆ° requirements.txt"
          pip install -r requirements.txt
        else
          echo "âŒ æœªæ‰¾åˆ° requirements.txtï¼Œä½¿ç”¨æ‰‹åŠ¨å®‰è£…"
          pip install python-telegram-bot==20.8 python-dotenv==1.0.1 requests==2.31.0 pytz==2023.3
        fi
        
    - name: ğŸ”§ é…ç½®ç¯å¢ƒ
      run: |
        mkdir -p é…ç½®æ–‡ä»¶
        echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "LOG_LEVEL=INFO" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "TIMEZONE=Asia/Shanghai" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        echo "DATABASE_PATH=phone_records.db" >> é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env
        
    - name: ğŸ§ª æµ‹è¯•æœºå™¨äººè¿æ¥
      run: |
        python -c "
        import requests
        import os
        from dotenv import load_dotenv
        
        load_dotenv('é…ç½®æ–‡ä»¶/ç¯å¢ƒé…ç½®.env')
        bot_token = os.getenv('BOT_TOKEN')
        
        if not bot_token:
            print('âŒ BOT_TOKEN æœªè®¾ç½®')
            exit(1)
            
        try:
            response = requests.get(f'https://api.telegram.org/bot{bot_token}/getMe', timeout=10)
            if response.status_code == 200:
                data = response.json()
                if data['ok']:
                    bot_info = data['result']
                    print(f'âœ… æœºå™¨äººè¿æ¥æˆåŠŸ')
                    print(f'ğŸ¤– æœºå™¨äººåç§°: {bot_info[\"first_name\"]}')
                    print(f'ğŸ‘¤ ç”¨æˆ·å: @{bot_info[\"username\"]}')
                    print(f'ğŸ†” ID: {bot_info[\"id\"]}')
                else:
                    print(f'âŒ APIè¿”å›é”™è¯¯: {data}')
                    exit(1)
            else:
                print(f'âŒ HTTPé”™è¯¯: {response.status_code}')
                exit(1)
        except Exception as e:
            print(f'âŒ è¿æ¥å¤±è´¥: {e}')
            exit(1)
        "
        
    - name: ğŸš€ å¯åŠ¨æœºå™¨äºº24å°æ—¶è¿è¡Œ
      run: |
        echo "ğŸ¤– å¯åŠ¨Telegramå®¢æˆ·å·ç ç»Ÿè®¡æœºå™¨äºº..."
        echo "â° å¼€å§‹æ—¶é—´: $(date)"
        echo "ğŸ”„ å°†è¿è¡Œ24å°æ—¶åè‡ªåŠ¨é‡å¯"
        echo "ğŸ“Š 24å°æ—¶æŒç»­è¿è¡Œæ¨¡å¼"

        # å¯åŠ¨æœºå™¨äººï¼Œè¿è¡Œ24å°æ—¶ (86400ç§’)
        timeout 86400 python å¯åŠ¨æœºå™¨äºº.py || {
          echo "âš ï¸ æœºå™¨äººè¿è¡Œ24å°æ—¶å®Œæˆï¼Œå‡†å¤‡é‡å¯..."
          echo "â° ç»“æŸæ—¶é—´: $(date)"
          exit 0
        }
        
    - name: ğŸ“Š ä¸Šä¼ æ—¥å¿—å’Œæ•°æ®
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bot-data-${{ github.run_number }}
        path: |
          *.log
          *.db
        retention-days: 7
